<div (click)="onClickOutside($event)">
  <div class="container">
    <div class="main-card">
      <!-- ðŸ”· Navbar -->
      <div class="inner-navbar d-flex justify-content-between align-items-center">
        <h5>Purchase Order</h5>

        <div class="row mt-2">
          <div class="col-md-12 text-end">
            <button class="btn btn-primary px-4 g-2" (click)="onSubmit()">
              <span *ngIf="!isEditMode">Submit Purchase Order</span>
              <span *ngIf="isEditMode">Update Purchase Order</span>
            </button>

            <!-- âž• PO Inquiry Button -->
            <button class="btn btn-primary ms-2"
                    (click)="goToPOInquiry()">
              PO Inquiry
            </button>
          </div>
        </div>

      </div>

      <!-- ðŸŒ¤ï¸ HEADER SECTION (compact + inline fields) -->
      <div class="form-section header-highlight">
        <div class="row align-items-center mb-2">

          <div class="col-md-3 d-flex align-items-center" *ngIf="isEditMode">
            <label class="form-label me-1 mb-0">Doc No:</label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="header.pono"
                   readonly />
          </div>

          <div class="col-md-3 d-flex align-items-center">
            <label class="form-label mb-1">Supplier:</label>
            <div class="dropdown w-100 supplier-dropdown" style="position: relative;">

              <input type="text"
                     class="form-control"
                     [(ngModel)]="searchText"
                     (focus)="onSupplierFocus()"
                     (input)="filterSuppliers()"
                     placeholder="Search Supplier by Name or Code"
                     [readonly]="supplierReadonly" />

              <!-- Dropdown Box -->
              <ul *ngIf="showDropdown && !supplierReadonly"
                  class="dropdown-menu w-100 show mt-1 p-1"
                  style="height: fit-content; max-height: 70px; overflow-y: auto;">

                <!-- No results -->
                <li *ngIf="filteredSuppliers.length === 0"
                    class="dropdown-item text-muted">
                  No result found
                </li>

                <!-- Results -->
                <li *ngFor="let v of filteredSuppliers">
                  <button class="dropdown-item"
                          (click)="onSupplierSelect(v)">
                    {{ v.name }} ({{ v.code }})
                  </button>
                </li>

              </ul>
            </div>
          </div>

          <div class="col-md-3 d-flex align-items-center">
            <label class="form-label mb-1">PO Type:</label>
            <div class="dropdown w-100 poType-dropdown" style="position: relative;">

              <input type="text"
                     class="form-control"
                     [(ngModel)]="poTypeSearch"
                     (focus)="onPoTypeFocus()"
                     (input)="filterPoTypes()"
                     placeholder="Search PO Type"
                     [readonly]="doctypeReadonly" />

              <ul *ngIf="showPoTypeDropdown && !doctypeReadonly"
                  class="dropdown-menu w-100 show mt-1 p-1"
                  style="height: fit-content; max-height: 70px; overflow-y: auto;">

                <li *ngIf="filteredPoTypes.length === 0"
                    class="dropdown-item text-muted">
                  No result found
                </li>

                <li *ngFor="let p of filteredPoTypes">
                  <button class="dropdown-item"
                          type="button"
                          (click)="selectPoType(p)">
                    {{ p.code }}
                  </button>
                </li>
              </ul>

            </div>
          </div>



              <div class="col-md-3 d-flex align-items-center">
                <label class="form-label me-2 mb-0">PO Date:</label>
                <input type="date"
                       class="form-control short-date"
                       [(ngModel)]="header.podt" />
              </div>

            </div>
          </div>

          <!-- ðŸ§© DETAIL ENTRY SECTION -->
          <div class="form-section">

            <!-- ROW 1 â†’ 4 inputs -->
            <div class="row g-2 mb-3">

              <div class="col-md-3">
                <label class="form-label">Part</label>
                <div class="dropdown part-dropdown" style="position:relative" (click)="$event.stopPropagation()">

                  <input type="text"
                         class="form-control"
                         [(ngModel)]="partSearch"
                         (focus)="showPartDropdown = true"
                         (input)="filterParts()"
                         placeholder="Search Part" />

                  <ul *ngIf="showPartDropdown"
                      class="dropdown-menu w-100 show mt-1"
                      style="max-height:120px; overflow:auto">

                    <li *ngIf="filteredParts.length === 0"
                        class="dropdown-item text-muted">
                      No result found
                    </li>

                    <li *ngFor="let p of filteredParts">
                      <button class="dropdown-item"
                              type="button"
                              (click)="selectPart(p)">
                        {{ p.code }}
                      </button>
                    </li>
                  </ul>

                </div>
              </div>



              <div class="col-md-3">
                <label class="form-label">Make</label>
                <div class="dropdown make-dropdown" style="position:relative" (click)="$event.stopPropagation()">

                  <input type="text"
                         class="form-control"
                         [(ngModel)]="makeSearch"
                         (focus)="showMakeDropdown = true"
                         (input)="filterMakes()"
                         placeholder="Search Make" />

                  <ul *ngIf="showMakeDropdown"
                      class="dropdown-menu w-100 show mt-1"
                      style="max-height:120px; overflow:auto">

                    <li *ngFor="let m of filteredMakes">
                      <button class="dropdown-item"
                              type="button"
                              (click)="selectMake(m)">
                        {{ m.code }}
                      </button>
                    </li>
                  </ul>

                </div>
              </div>



              <div class="col-md-3">
                <label class="form-label">Qty</label>
                <input type="number"
                       class="form-control"
                       [(ngModel)]="detail.qty"
                       (input)="updateValue()" />
              </div>

              <div class="col-md-3">
                <label class="form-label">Price</label>
                <input type="number"
                       class="form-control"
                       [(ngModel)]="detail.unitprice"
                       (input)="updateValue()" />
              </div>

            </div>


            <!-- ROW 2 â†’ 3 inputs + BUTTON -->
            <div class="row g-3 align-items-end mb-3">

              <div class="col-md-3">
                <label class="form-label">Discount</label>
                <input type="number"
                       class="form-control"
                       [(ngModel)]="detail.discount"
                       (input)="updateValue()" />
              </div>

              <div class="col-md-3">
                <label class="form-label">Value</label>
                <input type="number"
                       class="form-control"
                       [(ngModel)]="detail.totalvalue"
                       readonly />
              </div>

              <div class="col-md-3">
                <label class="form-label">VAT%</label>
                <input type="number"
                       class="form-control"
                       [(ngModel)]="detail.vatpercentage"
                       placeholder="Vat" />
              </div>

              <!-- ADD BUTTON -->
              <div class="col-md-3 d-flex align-items-end gap-1">
                <button class="btn btn-primary w-100"
                        (click)="isEditing ? updateDetail() : addDetail()">
                  {{ isEditing ? 'Update' : 'Add' }}
                </button>

                <button type="button"
                        class="btn btn-outline-primary w-97"
                        (click)="onClear()">
                  Clear
                </button>
              </div>

            </div>

            <!-- TABLE (unchanged) -->
            <div class="table-container mt-3 fixed-rows-3">
              <div class="table-rounded">
                <div class="table-scroll">
                  <table class="table table-striped table-hover mb-0">
                    <thead class="table-header">
                      <tr>
                        <th>#</th>
                        <th>Part</th>
                        <th>Make</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Value</th>
                        <th class="text-center">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of details; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td>{{ item.part }}</td>
                        <td>{{ item.make }}</td>
                        <td>{{ item.qty }}</td>
                        <td>{{ item.unitprice }}</td>
                        <td>{{ item.totalvalue }}</td>

                        <td class="text-center">
                          <button class="btn btn-sm btn-outline-primary me-1"
                                  (click)="editDetail(i)">
                            Edit
                          </button>
                          <button class="btn btn-sm btn-outline-danger"
                                  (click)="removeDetail(i)">
                            Delete
                          </button>
                        </td>
                      </tr>

                      <tr *ngIf="details.length === 0">
                        <td colspan="7" class="text-center text-muted">
                          No items added yet.
                        </td>
                      </tr>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>

        </div>
  </div>
</div>
